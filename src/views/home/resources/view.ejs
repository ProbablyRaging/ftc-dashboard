<!DOCTYPE html>
<html lang="en">

<!-- Header -->

<head>
    <title><%= post.title %></title>
    <meta name="description" content="This is a test post">
    <meta name="author" content="ForTheContent">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimal-ui">
    <meta name="theme-color" content="#1a1e23">

    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= post.title %>">
    <meta property="og:description" content="This is a test post">
    <meta property="og:image" content="<%= post.image %>">

    <meta property="og:url" content="https://forthecontent.xyz/">
    <meta property="og:site_name" content="ForTheContent">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= post.title %>">
    <meta name="twitter:description" content="This is a test post">
    <meta name="twitter:image" content="<%= post.image %>">
    <meta name="twitter:site" content="@forthecontent">
    <meta name="keywords" content="discord server for content creators, content creator discord server, discord server for small content creators">

    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://forthecontent.xyz/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" href="https://forthecontent.xyz/images/android-chrome-192x192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://forthecontent.xyz/images/apple-touch-icon.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="https://www.delac.io/WOW/css/libs/animate.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- WOW Animation -->
    <script src="https://www.delac.io/WOW/dist/wow.min.js"></script>
    <script>
        wow = new WOW({ mobile: true });
        wow.init();
    </script>

    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/sn859udbwuko5zl0h8tp6q4dv6xil8zqzr15o6cs04pnkry0/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/stylesheets/home.css">
</head>

<body class="home child__page">
    <!-- Navbar -->
    <%- include('../partials/home/navbar') -%>

    <!-- Header -->
    <div class="main-div">
        <main class="page__content page--transition-fade" data-swup="0">
        </main>
    </div>

    <!-- Page body -->
    <div class="wp-block-vbi-section softer-white section__bg-color section body__section">
        <div class="container content__area container--res-post container--responsive-padding">
            <div class="wp-block-vbi-two-column-layout row content__area row--center content__res">
                <div class="wp-block-vbi-column-layout col col--md-6 content__area content__res">

                    <div class="post-wrapper">
                        <div class="resource-breadcrumb">
                            <span><a href="/">Home</a> > <a href="/resources">Resources</a> > <%= post.title %></span>
                        </div>

                        <h1 class="post-title" id="post-title"><%= post.title %></h1>

                        <div class="post__info">
                            <div class="post__avatar">
                                <img src="https://cdn.discordapp.com/avatars/<%= post.userId %>/<%= post.avatar %>.webp" alt="author">
                            </div>
                            <div class="post__author">
                                <p class="post-author"><%= post.author %></p>
                                <p class="post-time"><%= post.timestamp.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', day: 'numeric' , month: 'short'}) %></p>
                            </div>
                        </div>
                        <div class="post-controls">
                            <% if (isStaff) { %>
                            <button class="button button--tertiary button--dense post-edit" onclick="makeEditable()">Edit</button>
                            <button class="button button--primary button--dense post-save" style="display: none;" onclick="saveEdit('<%= post.id %>')">Save</button>
                            <button class="button button--danger button--dense post-delete" onclick="deletePost('<%= post.id %>')"">Delete</button>
                            <button class=" button button--primary button--dense post-publish" onclick="publishToDiscord('<%= post.id %>', '<%= post.published %>')"">Publish To Discord</button>
                            <% } %>
                        </div>

                        <div class=" post-body-wrapper">
                                <%- post.body %>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        function makeEditable() {
            $('.post-edit').css('display', 'none');
            $('.post-save').css('display', 'block');
            $('.post-body-wrapper').attr('id', 'editable').css('border', '1px solid #000');

            const currentTitle = document.getElementById('post-title').innerHTML;
            var input = $('<input />', {
                'name': 'resource-title',
                'id': 'resource-title',
                'class': 'res-input',
                'value': currentTitle
            });
            $('.post-title').replaceWith(input)

            tinymce.init({
                selector: "#editable",
                inline: true,
                plugins: 'preview importcss searchreplace autolink autosave directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap emoticons',
                editimage_cors_hosts: ['picsum.photos'],
                menubar: 'file edit view insert format tools table help',
                toolbar: 'undo redo | bold italic underline strikethrough | fontsize blocks | forecolor backcolor removeformat | alignleft aligncenter alignright alignjustify | fullscreen preview | image media template link anchor codesample | outdent indent |  numlist bullist | pagebreak | charmap emoticons | ltr rtl',
                autosave_interval: '30s',
                autosave_prefix: '{path}{query}-{id}-',
                autosave_restore_when_empty: false,
                autosave_retention: '2m',
                importcss_append: true,
                template_cdate_format: '[Date Created (CDATE): %m/%d/%Y : %H:%M:%S]',
                template_mdate_format: '[Date Modified (MDATE): %m/%d/%Y : %H:%M:%S]',
                height: 600,
                image_caption: true,
                quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
                noneditable_class: 'mceNonEditable',
                toolbar_mode: 'sliding',
                contextmenu: 'link image table'
            });

            const toast = new bootstrap.Toast(successToast);
            toast.show();
        }

        function saveEdit(id) {
            const title = document.getElementById('resource-title').value;
            const body = tinyMCE.activeEditor.getContent();
            const image = $('.post-body-wrapper').find('img').attr('src');
            // If no title
            if (body === '') {
                const toast = new bootstrap.Toast(titleToast);
                return toast.show();
            }
            // If no title
            if (title === '') {
                const toast = new bootstrap.Toast(titleToast);
                return toast.show();
            }
            $.post({
                url: `/resources/edit`,
                type: 'POST',
                headers: { "Content-Type": "application/json" },
                dataType: 'json',
                data: JSON.stringify({ "id": id, "title": `${title}`, "body": `${body}`, "image": `${image}` })
            }, (data) => {
                if (data.status === 'ok') {
                    $('.post-body-wrapper').removeAttr('id', 'editable').css('border', 'none');
                    window.location = `/resources/${data.slug}`;
                } else if (data.status === 'error') {
                    const toast = new bootstrap.Toast(unknownToast);
                    toast.show();
                } else {
                    const toast = new bootstrap.Toast(errorToast);
                    toast.show();
                }
            });
        }

        function deletePost(id) {
            if (confirm('Are you sure you want to permanently delete this post?') === true) {
                $.post({
                    url: `/resources/delete`,
                    type: 'POST',
                    headers: { "Content-Type": "application/json" },
                    dataType: 'json',
                    data: JSON.stringify({ "id": id })
                }, (data) => {
                    if (data.status === 'ok') {
                        window.location = '/resources';
                    } else if (data.status === 'error') {
                        const toast = new bootstrap.Toast(unknownToast);
                        toast.show();
                    }
                });
            }
        }

        function publishToDiscord(id, status) {
            if (status === 'true') {
                const toast = new bootstrap.Toast(publishedToast);
                return toast.show();
            }
            if (confirm('Are you sure you want to publish this resource to Discord?') === true) {
                $.post({
                    url: `/resources/publish`,
                    type: 'POST',
                    headers: { "Content-Type": "application/json" },
                    dataType: 'json',
                    data: JSON.stringify({ "url": window.location.href, "id": id })
                }, (data) => {
                    if (data.status === 'ok') {
                        $('.post-publish').prop('disabled', true);
                        const toast = new bootstrap.Toast(publishToast);
                        toast.show();
                    } else {
                        const toast = new bootstrap.Toast(unknownToast);
                        toast.show();
                    }
                });
            }
        }
    </script>

    <!-- Toast Error -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-danger">
                Please include at least one image
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="unknownToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-danger">
                An unknown error occured. Please save your work and try again
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="titleToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-danger">
                Please include a title
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="publishedToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-danger">
                This resource has already been published
            </div>
        </div>
    </div>

    <!-- Toast Success -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-primary">
                Edit mode
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="publishToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-light bg-primary">
                Resource published
            </div>
        </div>
    </div>

    <!-- Footer -->
    <%- include('../partials/home/footer') -%>
    <!-- Share Button -->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-6302de00a27d877d"></script>
</body>